<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trust Bazaar DEBUG</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root {
            --pi-purple: #673ab7;
        }

        body {
            font-family: sans-serif;
            background: #f4f7f6;
            margin: 0;
            text-align: center;
        }

        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--pi-purple);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .card {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div id="loader-container">
        <div class="spinner"></div>
        <p style="color: white;">Waiting for Pi SDK...</p>
    </div>

    <div class="card">
        <h1 style="color: var(--pi-purple);">Trust Bazaar v1.2</h1>
        <p>User: <span id="user-name">Not Connected</span></p>
        <button onclick="login()"
            style="padding: 15px; width: 80%; background: var(--pi-purple); color: white; border: none; border-radius: 10px; font-weight: bold;">Connect
            Wallet</button>

        <button class="btn" style="background: #2196f3; color: white;" onclick="checkWalletEligibility()">
            Check Eligibility (Free)
        </button>
    </div>

    <div id="debug-box"
        style="background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; height: 200px; overflow-y: auto; text-align: left;">
        <b>SYSTEM LOGS:</b>
        <div id="log-output"></div>
    </div>

    <script>
        function log(msg) {
            const output = document.getElementById('log-output');
            output.innerHTML += `<div>> ${msg}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        window.onload = function () {
            log("üì° API Handshake Starting...");

            // 1. FAILSAFE: Remove the curtain after 6 seconds if SDK hangs
            setTimeout(() => {
                const loader = document.getElementById('loader-container');
                if (loader && loader.style.display !== 'none') {
                    loader.style.display = 'none';
                    log("‚ö†Ô∏è SDK took too long. Forced entry.");
                }
            }, 6000);

            // 2. MANDATORY: The 'Incomplete Payment' Callback
            // Without this, Pi.init will hang forever!
            const onIncompletePaymentFound = (payment) => {
                log("üîç API: Found stuck transaction: " + payment.identifier);
                // This is where your API Key works behind the scenes
            };

            try {
                log("üîó Initializing Pi SDK...");

                // Start the SDK
                Pi.init({ version: "2.0" });
                log("‚úÖ SDK Signal Received.");

                // 3. IMMEDIATE AUTH: This "wakes up" the Sandbox and S23
                Pi.authenticate(['username', 'payments'], onIncompletePaymentFound)
                    .then(function (auth) {
                        log("üë§ Welcome, " + auth.user.username);
                        document.getElementById('user-name').innerText = auth.user.username;

                        // Hide loader once authenticated
                        const loader = document.getElementById('loader-container');
                        if (loader) loader.style.display = 'none';
                    })
                    .catch(function (err) {
                        log("‚ùå API Auth Error: " + err.message);
                        // Even if auth fails, we hide the loader to see the error
                        document.getElementById('loader-container').style.display = 'none';
                    });

            } catch (e) {
                log("‚ùå SDK Fatal Error: " + e.message);
                document.getElementById('loader-container').style.display = 'none';
            }
        };
            }

        function checkWalletEligibility() {
            log("üîç Verifying Wallet Eligibility...");

            // We check if the user is authenticated first
            if (document.getElementById('user-name').innerText === "Pioneer") {
                log("‚ùå Error: Please connect your wallet first!");
                return;
            }

            log("üì° Pinging Pi Blockchain for status...");

            // In a real scenario, you'd call your backend here. 
            // For the MVP, we simulate a 'Gas Check'
            setTimeout(() => {
                const hasBalance = true; // Simulated check
                if (hasBalance) {
                    log("‚úÖ Balance Confirmed: > 1 Pi available.");
                    log("üõ°Ô∏è Security Circle: Verified.");
                    document.getElementById('audit-status').innerText = "Wallet Eligible for 85% Score";
                    document.getElementById('audit-status').style.color = "#4caf50";
                } else {
                    log("‚ùå Insufficient Pi for Trust Deposit.");
                }
            }, 1500);
        }
        function showFinalResult() {
            log("üìä Generating Verified Certificate...");
            document.getElementById('audit-box').style.display = 'none';

            const dashboard = document.getElementById('dashboard-section');
            const username = userAccountData ? userAccountData.username : "Pioneer";

            // The "Certificate" UI
            dashboard.innerHTML = `
        <div class="card certificate-card" style="border: 4px double #4caf50; padding: 30px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; font-size: 100px; color: rgba(76, 175, 80, 0.1); transform: rotate(-20deg);">üõ°Ô∏è</div>
            
            <h3 style="color: #4caf50; text-transform: uppercase; letter-spacing: 2px;">Trust Protocol Verified</h3>
            <hr style="border: 0; border-top: 1px solid #eee;">
            
            <p style="margin-top: 20px;">This certifies that</p>
            <h2 style="color: #333; margin: 10px 0;">${username}</h2>
            <p>has completed the <b>Level 1 Reputation Audit</b></p>
            
            <div style="margin: 30px 0;">
                <div style="font-size: 14px; color: #666;">FINAL TRUST SCORE</div>
                <div style="font-size: 50px; font-weight: bold; color: #4caf50;">88%</div>
            </div>

            <div style="display: flex; justify-content: space-around; font-size: 12px; color: #777;">
                <div>ID: ${Math.random().toString(36).substr(2, 9).toUpperCase()}</div>
                <div>DATE: ${new Date().toLocaleDateString()}</div>
            </div>

            <button class="btn" style="margin-top: 30px; background: #673ab7; color: white;" onclick="location.reload()">Return to Bazaar</button>
        </div>
    `;

            // S23 haptic feedback for success
            if (window.navigator.vibrate) window.navigator.vibrate([100, 50, 100]);
        }
    </script>
</body>

</html>