<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trust Bazaar DEBUG</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        :root {
            --pi-purple: #673ab7;
        }

        body {
            font-family: sans-serif;
            background: #f4f7f6;
            margin: 0;
            text-align: center;
        }

        #loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--pi-purple);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .card {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div id="loader-container">
        <div class="spinner"></div>
        <p style="color: white;">Waiting for Pi SDK...</p>
    </div>

    <div class="card">
        <h1 style="color: var(--pi-purple);">Trust Bazaar v1.2</h1>
        <p>User: <span id="user-name">Not Connected</span></p>
        <button onclick="login()"
            style="padding: 15px; width: 80%; background: var(--pi-purple); color: white; border: none; border-radius: 10px; font-weight: bold;">Connect
            Wallet</button>

        <button class="btn" style="background: #2196f3; color: white;" onclick="checkWalletEligibility()">
            Check Eligibility (Free)
        </button>
    </div>

    <div id="debug-box"
        style="background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; height: 200px; overflow-y: auto; text-align: left;">
        <b>SYSTEM LOGS:</b>
        <div id="log-output"></div>
    </div>

    <script>
        function log(msg) {
            const output = document.getElementById('log-output');
            output.innerHTML += `<div>> ${msg}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        window.onload = function () {
            log("üì° Starting System...");

            // 1. Force hide the purple loader
            setTimeout(() => {
                const loader = document.getElementById('loader-container');
                if (loader) loader.style.display = 'none';
                log("‚ö†Ô∏è Failsafe active.");
            }, 3000);

            // 2. Standard SDK Init
            try {
                log("üîó Initializing SDK...");
                Pi.init({ version: "2.0" }); // Simple init
                log("‚úÖ SDK Ready.");
            } catch (e) {
                log("‚ùå SDK Error: " + e.message);
            }
        };

        function login() {
            log("üöÄ Requesting Auth...");

            // This tells the SDK to look for both the user and potential payments
            Pi.authenticate(['username', 'payments'], function (payment) {
                log("Checking for incomplete payments...");
            }).then(function (auth) {
                log("‚úÖ CONNECTED: " + auth.user.username);

                // Update the UI on BOTH S23 and PC Sandbox
                document.getElementById('user-name').innerText = auth.user.username;
                document.getElementById('user-name').style.color = "#4caf50";

                // This is the 'Handshake' signal for the Sandbox
                if (window.parent) {
                    window.parent.postMessage({ type: 'auth_success', username: auth.user.username }, "*");
                }

            }).catch(function (err) {
                log("‚ùå AUTH ERROR: " + err.message);
            });
        }
        function checkWalletEligibility() {
            log("üîç Verifying Wallet Eligibility...");

            // We check if the user is authenticated first
            if (document.getElementById('user-name').innerText === "Pioneer") {
                log("‚ùå Error: Please connect your wallet first!");
                return;
            }

            log("üì° Pinging Pi Blockchain for status...");

            // In a real scenario, you'd call your backend here. 
            // For the MVP, we simulate a 'Gas Check'
            setTimeout(() => {
                const hasBalance = true; // Simulated check
                if (hasBalance) {
                    log("‚úÖ Balance Confirmed: > 1 Pi available.");
                    log("üõ°Ô∏è Security Circle: Verified.");
                    document.getElementById('audit-status').innerText = "Wallet Eligible for 85% Score";
                    document.getElementById('audit-status').style.color = "#4caf50";
                } else {
                    log("‚ùå Insufficient Pi for Trust Deposit.");
                }
            }, 1500);
        }
    </script>
</body>

</html>