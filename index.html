<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Bazaar | Merchant Command</title>
    <script src="library.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e1e;
            --gold: #FFD700;
            --pi-purple: #612F74;
            --green: #4CAF50;
            --red: #F44336;
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
        }

        .light-mode {
            --bg-dark: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #121212;
            --text-dim: #666666;
        }

        .hacker-mode {
            --bg-dark: #000000;
            --card-bg: #001100;
            --text-main: #00ff00;
            --text-dim: #008800;
            --gold: #00ff00;
            --pi-purple: #00ff00;
            --green: #00ff00;
            --red: #ff0000;
            font-family: 'Courier New', Courier, monospace;
        }

        .hacker-mode .card {
            border: 1px solid #00ff00;
            box-shadow: 0 0 5px #00ff00;
        }

        .hacker-mode .btn {
            background: #002200;
            color: #00ff00;
            border: 1px solid #00ff00;
        }

        .hacker-mode .btn:hover {
            background: #00ff00;
            color: black;
            box-shadow: 0 0 15px #00ff00;
        }

        .hacker-mode .trust-circle {
            background: conic-gradient(#00ff00 0% 0%, #003300 0% 100%);
            box-shadow: 0 0 20px #00ff00;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
            /* Prevent horizontal scroll from animations */
        }

        /* DASHBOARD GRID */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* CARDS */
        .card {
            background-color: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }

        .card h3 {
            margin-top: 0;
            color: var(--gold);
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        /* TRUST SCORE GAUGE */
        .trust-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--gold) 0% 0%, #333 0% 100%);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .trust-inner {
            width: 120px;
            height: 120px;
            background-color: var(--card-bg);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .score-big {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .score-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        /* TIERS & BADGES */
        .tier-badge {
            text-align: center;
            background: var(--pi-purple);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }

        /* PROGRESS BARS */
        .progress-container {
            margin-top: 15px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .progress-track {
            background: #333;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--gold);
            height: 100%;
            width: 0%;
            transition: width 1s ease;
        }

        /* STATUS INDICATORS */
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background: #252525;
            border-radius: 8px;
        }

        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .dot-green {
            background-color: var(--green);
            box-shadow: 0 0 8px var(--green);
        }

        .dot-red {
            background-color: var(--red);
            box-shadow: 0 0 8px var(--red);
        }

        .dot-yellow {
            background-color: var(--gold);
        }

        /* ACTION BUTTONS */
        .btn {
            background: linear-gradient(135deg, var(--gold), #e6c200);
            border: none;
            color: black;
            padding: 12px;
            width: 100%;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
            transition: all 0.3s ease;
            /* Added for smooth transitions */
        }

        .btn:hover {
            box-shadow: 0 0 20px var(--gold);
            /* Gold glow on hover */
            transform: translateY(-2px);
            /* Slight lift effect */
        }

        .btn:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--gold);
            color: var(--gold);
        }

        /* üé® CUSTOM MODAL STYLES (The Fix) */
        #custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: #1e1e1e;
            border: 2px solid var(--gold);
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-btn {
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 5px;
        }

        .btn-confirm {
            background: var(--gold);
            color: black;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid #666;
            color: #aaa;
        }

        /* üéä SUCCESS TOAST STYLES */
        .bounty-toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            padding: 15px 30px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 10000;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            font-weight: bold;
            border: 2px solid #fff;
            min-width: 250px;
        }

        .bounty-toast.show {
            bottom: 50px;
        }

        .badge-float {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 5px;
        }

        /* NOTIFICATIONS & CHART */
        .notification-container {
            position: relative;
            display: inline-block;
            margin-right: 10px;
        }

        .notification-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            position: relative;
            padding: 0;
        }

        .badge-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red);
            color: white;
            border-radius: 50%;
            padding: 2px 5px;
            font-size: 0.7rem;
            display: none;
            font-weight: bold;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 30px;
            background-color: var(--card-bg);
            min-width: 250px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
            z-index: 100;
            border: 1px solid #333;
            border-radius: 8px;
        }

        .dropdown-content div {
            color: var(--text-main);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            border-bottom: 1px solid #333;
            font-size: 0.9rem;
        }

        .dropdown-content div:last-child {
            border-bottom: none;
        }

        .show {
            display: block;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-top: 15px;
        }
    </style>
</head>

<body>

    <div class="bazaar-seal">
        <div class="seal-inner">
            <span class="pi-symbol">œÄ</span>
        </div>
        <div class="ribbon">EXCELLENCE</div>
    </div>

    <style>
        .bazaar-seal {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--gold), #B8860B);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
            margin: 10px auto 25px auto;
            border: 3px solid var(--pi-purple);
            animation: sealGlow 3s infinite alternate;
        }

        @keyframes sealGlow {
            from {
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
            }

            to {
                box-shadow: 0 4px 25px rgba(255, 215, 0, 0.5);
            }
        }

        .seal-inner {
            width: 75px;
            height: 75px;
            background: var(--pi-purple);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--gold);
        }

        .pi-symbol {
            color: var(--gold);
            font-size: 45px;
            font-weight: bold;
            font-family: 'serif';
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .ribbon {
            position: absolute;
            bottom: -8px;
            background: var(--gold);
            color: var(--pi-purple);
            padding: 2px 10px;
            font-size: 10px;
            font-weight: 900;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            letter-spacing: 1px;
            border: 1px solid #fff;
        }
    </style>

    <div
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; max-width: 600px; margin-left: auto; margin-right: auto;">
        <h2 style="margin:0; color: var(--gold);">MERCHANT COMMAND</h2>
        <div id="admin-display" style="font-size: 0.8rem; color: var(--text-dim); margin-right: 10px;">Admin: Loading...
        </div>
        <button id="maint-btn" class="btn btn-outline"
            style="display:none; width: auto; margin:0 5px; padding: 5px 10px; font-size: 0.8rem; border-color: var(--red); color: var(--red);"
            onclick="toggleMaintenance()">üõë MAINT</button>
        <div class="notification-container">
            <button class="notification-btn" onclick="toggleNotifications()">üîî<span id="notif-badge"
                    class="badge-count">0</span></button>
            <div id="notif-dropdown" class="dropdown-content">
                <div style="color:var(--text-dim); text-align:center; padding:10px;">No new notifications</div>
            </div>
        </div>
        <button id="transfer-admin-btn" class="btn btn-outline"
            style="display:none; width: auto; margin:0 10px; padding: 5px 10px; font-size: 0.8rem;"
            onclick="transferAdmin()">üëë TRANSFER</button>
        <button class="btn btn-outline" style="width:auto; margin:0 5px; padding: 8px 15px;"
            onclick="toggleHackerMode()">üíª</button>
        <button id="sound-btn" class="btn btn-outline" style="width:auto; margin:0 5px; padding: 8px 15px;"
            onclick="toggleSound()">üîá</button>
        <button class="btn btn-outline" style="width:auto; margin:0 5px; padding: 8px 15px;"
            onclick="toggleTheme()">üåì</button>
        <button id="connect-btn" class="btn btn-outline"
            style="width: auto; margin:0; padding: 8px 15px; font-size: 0.9rem;" onclick="connectWallet()">üîå CONNECT
            WALLET</button>
    </div>

    <div style="text-align: center; margin-bottom: 20px;">
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('dashboard')">üìä
            DASHBOARD</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('map')">üó∫Ô∏è MERCHANT
            MAP</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('shop')">üõí SHOP</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('voting')">üó≥Ô∏è
            VOTING</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('graph')">üï∏Ô∏è GRAPH</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('chat')">üí¨ CHAT</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('escrow')">‚öñÔ∏è ESCROW</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('multisig')">üîê MULTI-SIG</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('premium')">üíé PREMIUM</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('lottery')">üé∞ LOTTERY</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('profile')">üë§
            PROFILE</button>
        <button class="btn btn-outline" style="width:auto; margin: 0 5px;" onclick="switchView('history')">üìú
            HISTORY</button>
    </div>

    <div id="dashboard-view">
        <div class="dashboard-grid">
            <div class="card" style="text-align: center;">
                <h3>üõ°Ô∏è MERCHANT IDENTITY</h3>

                <div class="trust-circle" id="trust-gauge">
                    <div class="trust-inner">
                        <span class="score-big" id="ts-display">0%</span>
                        <span class="score-label">TRUST SCORE</span>
                    </div>
                </div>

                <div class="tier-badge" id="tier-name">ITERANT</div>

                <div class="progress-container">
                    <div class="progress-label">
                        <span>Next Tier: Proven</span>
                        <span id="next-tier-points">30 Pts Left</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="ts-bar" style="width: 0%;"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>üè¶ ECONOMIC STATUS</h3>

                <div class="status-row">
                    <span>Integrity Bond (20 Pi)</span>
                    <div>
                        <span class="status-dot dot-red" id="bond-dot"></span>
                        <span id="bond-text">NOT STAKED</span>
                    </div>
                </div>

                <div class="status-row">
                    <span>Medical Guard</span>
                    <div>
                        <span class="status-dot dot-green"></span>
                        <span>ACTIVE</span>
                    </div>
                </div>

                <div class="status-row">
                    <span>Market Mode</span>
                    <span style="color: var(--gold); font-weight: bold;">ASSET (LABOR PEG)</span>
                </div>

                <div class="status-row">
                    <span>Gas Station (Testnet)</span>
                    <button class="btn btn-outline" style="width:auto; padding: 2px 8px; font-size: 0.7rem;"
                        onclick="useGasStation()">‚õΩ REFUEL</button>
                </div>

                <div class="status-row">
                    <span>Bazaar Token (BZR)</span>
                    <span style="color: var(--pi-purple); font-weight: bold;" id="bzr-balance">0 BZR</span>
                    <button class="btn btn-outline" style="width:auto; padding: 2px 8px; font-size: 0.7rem;"
                        onclick="transferBZR()">SEND</button>
                </div>

                <div class="card" style="margin-top: 10px; border: 1px solid #333; padding: 10px;">
                    <h4 style="margin:0 0 10px 0; color:var(--gold);">ü§ù COMMUNITY FUND</h4>
                    <div style="text-align:center; margin-bottom:5px;">
                        <span style="font-size:1.5rem; color:var(--text-main);" id="fund-display">0 BZR</span>
                        <div style="font-size:0.7rem; color:var(--text-dim);">Goal: 1000 BZR</div>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="fund-bar" style="width: 0%;"></div>
                    </div>
                    <button class="btn btn-outline" style="margin-top:10px;" onclick="contributeCrowdfund()">üí∏
                        CONTRIBUTE 10 BZR</button>
                </div>

                <button class="btn" id="stake-btn" onclick="stakeBond()">üîí STAKE 20 PI BOND</button>
                <div id="bond-countdown"
                    style="text-align:center; font-size:0.8rem; color:var(--text-dim); margin-top:5px;"></div>
                <button class="btn btn-outline" id="withdraw-btn" style="display:none; margin-top: 5px;"
                    onclick="withdrawBond()">üîì WITHDRAW BOND</button>
            </div>

            <div class="card">
                <h3>‚ö° QUICK ACTIONS</h3>
                <button class="btn btn-outline" onclick="simulateTrade()">üõí SIMULATE TRADE (+2% TS)</button>
                <button class="btn btn-outline" onclick="vouchForPeer()">ü§ù VOUCH FOR PEER</button>
                <button class="btn btn-outline" onclick="checkPeerTrust()">üîç CHECK PEER TRUST</button>
                <button class="btn btn-outline" style="margin-top:10px; border-color: var(--red); color: var(--red);"
                    onclick="triggerDecay()">üìâ TRIGGER DECAY (ADMIN)</button>
                <button class="btn btn-outline" style="margin-top:10px; border-color: var(--red); color: var(--red);"
                    onclick="raiseDispute()">üö© RAISE DISPUTE</button>
                <button class="btn btn-outline"
                    style="margin-top:10px; border-color: var(--green); color: var(--green);"
                    onclick="resolveDispute()">üïäÔ∏è RESOLVE DISPUTE (ADMIN)</button>
                <button class="btn btn-outline" style="margin-top:10px; border-color: var(--red); color: var(--red);"
                    onclick="forceUnbond()">üîì FORCE UNBOND (ADMIN)</button>
                <button class="btn btn-outline" style="margin-top:10px; border-color: var(--red); color: var(--red);"
                    onclick="triggerEmergency()">üöë REPORT EMERGENCY</button>
            </div>

            <div class="card">
                <h3>üîç SEARCH</h3>
                <input type="text" id="search-input" placeholder="Search by Nickname..."
                    style="width: 65%; padding: 10px; border-radius: 5px; border: 1px solid #333; background: var(--bg-dark); color: var(--text-main);">
                <button class="btn btn-outline" style="width: 25%; padding: 10px;"
                    onclick="searchNickname()">GO</button>
            </div>
        </div>

        <!-- LEADERBOARD SECTION -->
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="card">
                <h3>üèÜ TOP MERCHANTS</h3>
                <div id="leaderboard-list" style="font-size: 0.9rem;">
                    <div
                        style="display:flex; justify-content:space-between; padding: 5px 0; border-bottom: 1px solid #333;">
                        <span>1. G...ABCD</span> <span style="color:var(--gold)">98%</span>
                    </div>
                    <div
                        style="display:flex; justify-content:space-between; padding: 5px 0; border-bottom: 1px solid #333;">
                        <span>2. G...WXYZ</span> <span style="color:var(--gold)">94%</span>
                    </div>
                    <div
                        style="display:flex; justify-content:space-between; padding: 5px 0; border-bottom: 1px solid #333;">
                        <span>3. G...1234</span> <span style="color:var(--gold)">89%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- EVENT LOG SECTION -->
        <div class="dashboard-grid" style="margin-top: 20px;">
            <div class="card">
                <h3>üì° LIVE CONTRACT EVENTS</h3>
                <div id="event-log"
                    style="font-size: 0.8rem; height: 150px; overflow-y: auto; color: var(--text-dim); font-family: monospace;">
                    <div>Waiting for blockchain events...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="graph-view" style="display:none; max-width: 800px; margin: 0 auto;">
        <div class="card" style="height: 500px; padding:0; overflow:hidden; position:relative;">
            <h3 style="position:absolute; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.5); padding:5px; border:none;">üï∏Ô∏è TRUST WEB</h3>
            <div id="d3-container" style="width:100%; height:100%;"></div>
        </div>
    </div>

    <div id="chat-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üí¨ ENCRYPTED CHAT</h3>
            <div id="message-list" style="height:200px; overflow-y:auto; border:1px solid #333; padding:10px; margin-bottom:10px; font-size:0.9rem;"></div>
            <input type="text" id="chat-target" placeholder="Recipient Address (G...)" style="width:100%; margin-bottom:5px; padding:5px; background:#222; border:1px solid #333; color:white;">
            <input type="text" id="chat-content" placeholder="Message..." style="width:100%; margin-bottom:5px; padding:5px; background:#222; border:1px solid #333; color:white;">
            <button class="btn btn-outline" onclick="sendMessage()">SEND ENCRYPTED</button>
            <button class="btn btn-outline" style="margin-top:5px;" onclick="fetchMessages()">üîÑ REFRESH INBOX</button>
        </div>
    </div>

    <div id="escrow-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>‚öñÔ∏è ESCROW CONTRACTS</h3>
            <input type="text" id="escrow-seller" placeholder="Seller Address (G...)" style="width:100%; margin-bottom:5px; padding:5px; background:#222; border:1px solid #333; color:white;">
            <input type="number" id="escrow-amount" placeholder="Amount (BZR)" style="width:100%; margin-bottom:5px; padding:5px; background:#222; border:1px solid #333; color:white;">
            <button class="btn" onclick="createEscrow()">CREATE ESCROW</button>
            <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                <h4 style="margin:0 0 5px 0;">Active Actions</h4>
                <input type="number" id="approve-id" placeholder="Escrow ID" style="width:60%; padding:5px; background:#222; border:1px solid #333; color:white;">
                <button class="btn btn-outline" style="width:35%;" onclick="approveEscrow()">APPROVE</button>
            </div>
        </div>
    </div>

    <div id="multisig-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üîê MULTI-SIG WALLET</h3>
            <button class="btn btn-outline" onclick="createWallet()">CREATE NEW WALLET</button>
            <div style="margin-top:15px; border-top:1px solid #333; padding-top:10px;">
                <input type="number" id="ms-wallet-id" placeholder="Wallet ID" style="width:20%; padding:5px; background:#222; border:1px solid #333; color:white;">
                <input type="number" id="ms-amount" placeholder="Amount" style="width:20%; padding:5px; background:#222; border:1px solid #333; color:white;">
                <button class="btn btn-outline" style="width:auto;" onclick="depositWallet()">DEPOSIT</button>
            </div>
            <div style="margin-top:10px;">
                <input type="text" id="ms-to" placeholder="To Address (G...)" style="width:60%; padding:5px; background:#222; border:1px solid #333; color:white;">
                <button class="btn btn-outline" style="width:auto;" onclick="proposeTx()">PROPOSE TX</button>
            </div>
            <div style="margin-top:10px;">
                <input type="number" id="ms-tx-id" placeholder="Tx ID" style="width:30%; padding:5px; background:#222; border:1px solid #333; color:white;">
                <button class="btn btn-outline" style="width:auto;" onclick="approveTx()">APPROVE TX</button>
            </div>
        </div>
    </div>

    <div id="premium-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card" style="text-align:center;">
            <h3>üíé PREMIUM MEMBERSHIP</h3>
            <p style="color:var(--text-dim);">Access exclusive market analytics and priority support.</p>
            <div id="sub-status" style="font-size:1.2rem; margin:15px 0; color:var(--red);">INACTIVE</div>
            <button class="btn" onclick="subscribe()">SUBSCRIBE (50 BZR/mo)</button>
        </div>
    </div>

    <div id="lottery-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card" style="text-align:center;">
            <h3>üé∞ BAZAAR LOTTERY</h3>
            <div style="font-size:2rem; color:var(--gold); margin:10px 0;" id="lotto-pot">Pot: 0 BZR</div>
            <p style="color:var(--text-dim);">Ticket Price: 10 BZR</p>
            <button class="btn" onclick="buyTicket()">üéüÔ∏è BUY TICKET</button>
            <button class="btn btn-outline" style="margin-top:10px; border-color:var(--green); color:var(--green);" onclick="runLottery()">üé≤ RUN LOTTERY (ADMIN)</button>
        </div>
    </div>

    <div id="map-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card"
            style="height: 400px; display:flex; align-items:center; justify-content:center; background: #222; border: 2px dashed var(--text-dim);">
            <div style="text-align:center;">
                <h3 style="color:var(--text-dim); border:none;">üó∫Ô∏è MAP INTERFACE</h3>
                <p style="color:var(--text-dim)">Geolocation nodes would appear here.</p>
            </div>
        </div>
    </div>

    <div id="shop-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üõí BAZAAR SHOP</h3>
            <div
                style="display:flex; justify-content:space-between; align-items:center; padding: 10px; border-bottom: 1px solid #333;">
                <div>
                    <div style="font-weight:bold; color:var(--gold);">Verified Merchant Badge</div>
                    <div style="font-size:0.8rem; color:var(--text-dim);">Display a verified checkmark on your profile.
                    </div>
                </div>
                <button class="btn btn-outline" style="width:auto;" onclick="buyBadge('verified')">50 BZR</button>
            </div>
        </div>
    </div>

    <div id="voting-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üó≥Ô∏è GOVERNANCE</h3>
            <div style="border: 1px solid #333; padding: 15px; border-radius: 8px;">
                <h4 style="margin:0 0 5px 0; color:var(--text-main);">Proposal #1: Increase Staking Reward</h4>
                <p style="font-size:0.9rem; color:var(--text-dim);">Should we increase the Trust Score bonus for staking
                    from +10 to +15?</p>
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="btn btn-outline" style="width:48%; border-color:var(--green); color:var(--green);"
                        onclick="vote(1, true)">YES</button>
                    <button class="btn btn-outline" style="width:48%; border-color:var(--red); color:var(--red);"
                        onclick="vote(1, false)">NO</button>
                </div>
                <div id="vote-stats-1" style="margin-top:10px; font-size:0.8rem; text-align:center; color:var(--gold);">
                </div>
            </div>
            <button class="btn btn-outline" style="margin-top:15px;" onclick="createProposal()">üìù CREATE PROPOSAL (100
                BZR)</button>
        </div>
    </div>

    <div id="profile-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üë§ MERCHANT PROFILE</h3>
            <div style="margin-bottom: 10px; color: var(--text-dim);">Current Nickname: <span id="current-nickname"
                    style="color:var(--gold); font-weight:bold;">Loading...</span></div>
            <input type="text" id="nickname-input" placeholder="Enter new nickname (max 10 chars)"
                style="width: 90%; padding: 10px; border-radius: 5px; border: 1px solid #333; background: #222; color: white; margin-bottom: 10px;">
            <button class="btn" onclick="setNickname()">üíæ SAVE PROFILE</button>
            <button class="btn btn-outline" style="margin-top:10px;" onclick="showQRCode()">üì± SHOW QR CODE</button>
        </div>
    </div>

    <div id="history-view" style="display:none; max-width: 600px; margin: 0 auto;">
        <div class="card">
            <h3>üìú TRANSACTION HISTORY</h3>
            <button class="btn btn-outline" style="margin-bottom:10px; width:auto; font-size:0.8rem;"
                onclick="downloadReport()">üì• DOWNLOAD CSV</button>
            <div id="history-list" style="font-size: 0.9rem; color: var(--text-dim);">
                <div style="padding:10px; text-align:center;">No recent transactions found.</div>
            </div>
        </div>
    </div>

    <div id="custom-modal-overlay" style="display: none;">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; color: var(--gold);">‚ö†Ô∏è CONFIRMATION</h3>
            <p id="modal-message" style="font-size: 1.1rem; margin: 20px 0;">Message goes here...</p>

            <div id="modal-actions">
            </div>
        </div>
    </div>

    <script>
        // --- üß† DASHBOARD LOGIC ENGINE ---

        let userPublicKey = null;
        let transactionHistory = [];

        async function connectWallet() {
            if (typeof window.freighterApi === 'undefined') {
                alert("Freighter wallet not found! Please install the extension.");
                return;
            }
            try {
                const key = await window.freighterApi.getPublicKey();
                userPublicKey = key;
                const btn = document.getElementById('connect-btn');
                btn.innerText = `üü¢ ${key.substring(0, 4)}...${key.substring(52)}`;
                btn.disabled = true;
                fetchAdmin(); // Fetch admin once connected
                checkBondStatus(); // Check if user is already bonded
                fetchBalance(); // Check BZR balance
                checkBadges(); // Check for Verified Badge
                fetchCrowdfund(); // Check Fund Status
                fetchVoteStats(1); // Check Proposal 1
                fetchNickname(); // Get Nickname
                initChart(); // Load Chart
                fetchMessages(); // Load Inbox
            } catch (e) {
                console.error("Connection failed", e);
            }
        }

        // Initialize Stellar SDK (Testnet)
        const server = new StellarSdk.Server("https://horizon-testnet.stellar.org");
        const CONTRACT_ID = "CAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD2KM"; // ‚ö†Ô∏è REPLACE THIS WITH YOUR DEPLOYED CONTRACT ID

        let merchantState = {
            trustScore: 15, // Starting Score
            isBonded: false,
            tier: "ITERANT",
            bondTimestamp: 0
        };

        function updateUI() {
            // 1. Update Gauge Visual
            const angle = merchantState.trustScore * 3.6; // 360 deg / 100
            document.getElementById('trust-gauge').style.background =
                `conic-gradient(var(--gold) ${angle}deg, #333 0deg)`;

            // 2. Update Text
            document.getElementById('ts-display').innerText = merchantState.trustScore + "%";
            document.getElementById('ts-bar').style.width = merchantState.trustScore + "%";

            // 3. Calculate Tier
            let tierName = "ITERANT";
            let nextGoal = 30;

            if (merchantState.trustScore > 90) { tierName = "ELDER NOMINEE"; nextGoal = 100; }
            else if (merchantState.trustScore > 70) { tierName = "GENESIS MASTER"; nextGoal = 91; }
            else if (merchantState.trustScore > 30) { tierName = "PROVEN"; nextGoal = 71; }

            document.getElementById('tier-name').innerText = tierName;
            document.getElementById('next-tier-points').innerText = (nextGoal - merchantState.trustScore) + " Pts Left";

            // 4. Update Bond Status
            if (merchantState.isBonded) {
                document.getElementById('bond-dot').className = "status-dot dot-green";
                document.getElementById('bond-text').innerText = "SECURE";
                document.getElementById('stake-btn').innerText = "‚úÖ BOND ACTIVE";
                document.getElementById('stake-btn').disabled = true;
                document.getElementById('withdraw-btn').style.display = "block";
            }
        }

        // --- üé≠ CUSTOM MODAL SYSTEM ---

        function showModal(title, message, type, callback) {
            const overlay = document.getElementById('custom-modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const msgEl = document.getElementById('modal-message');
            const actionDiv = document.getElementById('modal-actions');

            // 1. Set Content
            titleEl.innerText = title;
            msgEl.innerText = message;
            actionDiv.innerHTML = ''; // Clear old buttons

            // 2. Create Buttons based on Type
            if (type === 'confirm') {
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'modal-btn btn-confirm';
                confirmBtn.innerText = '‚úÖ CONFIRM';
                confirmBtn.onclick = function () {
                    closeModal();
                    if (callback) callback();
                };

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'modal-btn btn-cancel';
                cancelBtn.innerText = 'CANCEL';
                cancelBtn.onclick = closeModal;

                actionDiv.appendChild(cancelBtn);
                actionDiv.appendChild(confirmBtn);

            } else if (type === 'alert') {
                const okBtn = document.createElement('button');
                okBtn.className = 'modal-btn btn-confirm';
                okBtn.innerText = 'UNDERSTOOD';
                okBtn.onclick = closeModal;

                actionDiv.appendChild(okBtn);
            }

            // 3. Show
            overlay.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('custom-modal-overlay').style.display = 'none';
        }

        // --- üèÜ SUCCESS TOAST & CONFETTI ENGINE ---

        function awardBounty(userName, trustBoost) {
            // Trigger Toast
            const toast = document.createElement('div');
            toast.className = 'bounty-toast';
            toast.innerHTML = `
                <span class="badge-float">üèÖ</span>
                GENESIS ACTION<br>
                <span style="font-size: 0.8rem;">+${trustBoost}% Trust Score Awarded</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            triggerConfetti();

            // Cleanup
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        function triggerConfetti() {
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.innerText = 'œÄ';
                particle.style.position = 'fixed';
                particle.style.left = Math.random() * 100 + 'vw';
                particle.style.top = '100vh';
                particle.style.fontSize = Math.random() * 20 + 10 + 'px';
                particle.style.color = '#FFD700';
                particle.style.zIndex = '99999';
                particle.style.transition = `all ${Math.random() * 2 + 1}s ease-out`;
                document.body.appendChild(particle);

                setTimeout(() => {
                    particle.style.top = '-10vh';
                    particle.style.transform = `rotate(${Math.random() * 360}deg)`;
                    particle.style.opacity = '0';
                }, 50);

                setTimeout(() => particle.remove(), 3000);
            }
        }

        // --- ‚ö° SIMULATIONS (UPDATED) ---

        function simulateTrade() {
            if (merchantState.trustScore < 100) {
                merchantState.trustScore += 2;
                updateUI();
                awardBounty("You", 2); // üü¢ ACTIVATED: Toast will show now!
            }
        }

        function stakeBond() {
            if (!merchantState.isBonded) {
                // REPLACED standard confirm() with showModal()
                showModal(
                    "üîí INTEGRITY VAULT",
                    "Are you sure you want to lock 20 Pi into the Integrity Bond? This cannot be withdrawn for 30 days.",
                    "confirm",
                    async function () {
                        try {
                            const referrer = prompt("Enter Referrer Address (Optional):");

                            // 0. Check for Wallet
                            if (typeof window.freighterApi === 'undefined') {
                                alert("Freighter wallet not found! Please install the extension.");
                                return;
                            }

                            console.log("Initiating Stake Transaction...");

                            // 1. Get User Identity
                            const publicKey = await window.freighterApi.getPublicKey();
                            const source = await server.loadAccount(publicKey);

                            // 2. Build Contract Call (Rust: fn stake(env, user))
                            const contract = new StellarSdk.Contract(CONTRACT_ID);
                            const op = contract.call("stake",
                                new StellarSdk.Address(publicKey).toScVal(),
                                referrer ? new StellarSdk.Address(referrer).toScVal() : StellarSdk.xdr.ScVal.scvVoid()
                            );

                            // 3. Construct & Sign Transaction
                            const tx = new StellarSdk.TransactionBuilder(source, {
                                fee: StellarSdk.BASE_FEE,
                                networkPassphrase: StellarSdk.Networks.TESTNET,
                            }).addOperation(op).setTimeout(30).build();

                            const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });

                            // 4. Submit to Blockchain
                            const result = await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                            console.log("Transaction Success:", result);

                            // 5. Update UI
                            merchantState.isBonded = true;
                            merchantState.trustScore += 10;
                            updateUI();
                            awardBounty("You", 10);
                        } catch (e) {
                            console.error("Transaction Failed:", e);
                            alert("Bonding failed. See console for details.");
                        }
                    }
                );
            }
        }

        async function vouchForPeer() {
            const targetAddress = prompt("Enter the Public Key (G...) of the merchant you want to vouch for:");
            if (!targetAddress) return;

            try {
                if (typeof window.freighterApi === 'undefined') {
                    alert("Freighter wallet not found!");
                    return;
                }

                console.log(`Initiating Vouch for ${targetAddress}...`);

                // 1. Get User Identity (Voucher)
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);

                // 2. Build Contract Call: fn vouch(env, voucher, target)
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call(
                    "vouch",
                    new StellarSdk.Address(publicKey).toScVal(),      // Voucher (You)
                    new StellarSdk.Address(targetAddress).toScVal()   // Target (Them)
                );

                // 3. Sign & Submit
                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                const result = await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));

                console.log("Vouch Success:", result);
                awardBounty("You", 5); // Reward for participating in governance
            } catch (e) {
                console.error("Vouch Failed:", e);
                alert("Vouch failed. Check console.");
            }
        }

        async function checkPeerTrust() {
            const targetAddress = prompt("Enter the Public Key (G...) to check trust:");
            if (!targetAddress) return;

            try {
                if (typeof window.freighterApi === 'undefined') {
                    alert("Freighter wallet not found!");
                    return;
                }

                console.log(`Checking trust for ${targetAddress}...`);

                // 1. Get User Identity (needed for simulation source)
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);

                // 2. Build Contract Call: fn get_trust(env, user) -> u32
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call(
                    "get_trust",
                    new StellarSdk.Address(targetAddress).toScVal()
                );

                // 3. Build Transaction for Simulation (Read-Only)
                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                // 4. Simulate & Decode
                const response = await server.simulateTransaction(tx);
                const resultVal = response.result.retval;
                const score = StellarSdk.scValToNative(resultVal);

                alert(`üõ°Ô∏è TRUST REPORT\n\nMerchant: ${targetAddress.substring(0, 6)}...${targetAddress.substring(50)}\nTrust Score: ${score}%`);
            } catch (e) {
                console.error("Check Trust Failed:", e);
                alert("Failed to check trust. See console.");
            }
        }

        async function withdrawBond() {
            try {
                if (typeof window.freighterApi === 'undefined') return alert("Wallet not found");

                console.log("Initiating Withdraw...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("withdraw", new StellarSdk.Address(publicKey).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                const result = await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));

                console.log("Withdraw Success:", result);
                merchantState.isBonded = false;
                merchantState.trustScore -= 10;
                merchantState.bondTimestamp = 0;
                document.getElementById('stake-btn').disabled = false;
                document.getElementById('stake-btn').innerText = "üîí STAKE 20 PI BOND";
                document.getElementById('withdraw-btn').style.display = "none";
                document.getElementById('bond-dot').className = "status-dot dot-red";
                document.getElementById('bond-text').innerText = "NOT STAKED";
                updateUI();
                document.getElementById('bond-countdown').innerText = "";
                alert("Bond Withdrawn. Trust Score adjusted.");
            } catch (e) {
                console.error("Withdraw Failed:", e);
                alert("Withdraw failed. Note: Bonds are locked for 30 days.");
            }
        }

        async function fetchAdmin() {
            try {
                const publicKey = await window.freighterApi.getPublicKey(); // Needed for simulation source
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_admin");

                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const response = await server.simulateTransaction(tx);
                const resultVal = response.result.retval;
                const adminAddr = StellarSdk.Address.fromScVal(resultVal).toString();
                document.getElementById('admin-display').innerText = `Admin: ${adminAddr.substring(0, 4)}...${adminAddr.substring(52)}`;

                // Show Transfer button if current user is admin
                if (userPublicKey === adminAddr) {
                    document.getElementById('transfer-admin-btn').style.display = "inline-block";
                    document.getElementById('maint-btn').style.display = "inline-block";
                }
            } catch (e) {
                console.log("Could not fetch admin", e);
            }
        }

        async function transferAdmin() {
            const newAdmin = prompt("Enter the Public Key (G...) of the NEW Admin:");
            if (!newAdmin) return;

            try {
                console.log("Transferring Admin...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("transfer_admin", new StellarSdk.Address(newAdmin).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));

                alert("Admin Transferred Successfully!");
                location.reload();
            } catch (e) {
                console.error("Transfer Failed:", e);
                alert("Transfer failed.");
            }
        }

        async function toggleMaintenance() {
            try {
                const isMaint = confirm("Toggle Maintenance Mode? (OK = ON, Cancel = OFF)");
                console.log("Setting Maintenance:", isMaint);
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("set_maintenance", StellarSdk.xdr.ScVal.scvBool(isMaint));

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Maintenance Mode Updated!"); checkMaintenanceStatus();
            } catch (e) { console.error(e); alert("Failed to toggle maintenance."); }
        }

        async function checkMaintenanceStatus() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("is_maintenance");
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const isMaint = StellarSdk.scValToNative(response.result.retval);

                const adminAddr = document.getElementById('admin-display').innerText.split(' ')[1];
                const isAdmin = userPublicKey && adminAddr && userPublicKey.includes(adminAddr.substring(0, 4)); // Simple check

                if (isMaint) {
                    document.getElementById('maint-btn').innerText = "üü¢ ACTIVE";
                    if (!isAdmin) {
                        const btns = document.querySelectorAll('button:not(#connect-btn)');
                        btns.forEach(b => { b.disabled = true; b.innerText = "‚õî MAINTENANCE"; });
                    }
                } else {
                    document.getElementById('maint-btn').innerText = "üõë MAINT";
                }
            } catch (e) { console.log("Error checking maintenance", e); }
        }

        async function checkBondStatus() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                // Call get_bond_time
                const op = contract.call("get_bond_time", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const response = await server.simulateTransaction(tx);
                const resultVal = response.result.retval;
                const bondTime = Number(StellarSdk.scValToNative(resultVal)); // Convert BigInt to Number

                if (bondTime > 0) {
                    merchantState.isBonded = true;
                    merchantState.bondTimestamp = bondTime;
                    updateUI();
                }
            } catch (e) {
                console.log("Not bonded or error checking status");
            }
        }

        function startCountdown() {
            if (merchantState.bondTimestamp > 0) {
                setInterval(() => {
                    const now = Math.floor(Date.now() / 1000);
                    const unlockTime = merchantState.bondTimestamp + (30 * 24 * 60 * 60); // 30 days
                    const diff = unlockTime - now;

                    if (diff <= 0) {
                        document.getElementById('bond-countdown').innerText = "‚úÖ Ready to Withdraw";
                        document.getElementById('withdraw-btn').style.display = "block";
                    } else {
                        const days = Math.floor(diff / 86400);
                        const hours = Math.floor((diff % 86400) / 3600);
                        document.getElementById('bond-countdown').innerText = `Locked: ${days}d ${hours}h`;
                        document.getElementById('withdraw-btn').style.display = "none";
                    }
                }, 1000);
            }
        }

        async function triggerDecay() {
            const targetAddress = prompt("Enter the Public Key (G...) to decay:");
            if (!targetAddress) return;

            try {
                if (typeof window.freighterApi === 'undefined') {
                    alert("Freighter wallet not found!");
                    return;
                }

                console.log(`Initiating Decay for ${targetAddress}...`);

                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);

                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call(
                    "decay",
                    new StellarSdk.Address(targetAddress).toScVal()
                );

                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                const result = await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));

                console.log("Decay Success:", result);
                alert("Decay applied. Trust Score reduced.");
            } catch (e) {
                console.error("Decay Failed:", e);
                alert("Decay failed. Check console.");
            }
        }

        async function fetchBalance() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_balance", new StellarSdk.Address(publicKey).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const resultVal = response.result.retval;
                const balance = StellarSdk.scValToNative(resultVal);
                document.getElementById('bzr-balance').innerText = `${balance} BZR`;
            } catch (e) {
                console.log("Error fetching balance", e);
            }
        }

        async function transferBZR() {
            const to = prompt("Enter Recipient Address (G...):");
            const amount = prompt("Enter Amount (BZR):");
            if (!to || !amount) return;

            try {
                console.log("Transferring BZR...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("transfer_bzr",
                    new StellarSdk.Address(publicKey).toScVal(),
                    new StellarSdk.Address(to).toScVal(),
                    StellarSdk.xdr.ScVal.scvU32(parseInt(amount))
                );

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Transfer Sent!");
                fetchBalance();
            } catch (e) { console.error(e); alert("Transfer failed"); }
        }

        async function buyBadge(badgeName) {
            try {
                if (!confirm(`Buy ${badgeName} badge for 50 BZR?`)) return;

                console.log("Buying Badge...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("buy_badge",
                    new StellarSdk.Address(publicKey).toScVal(),
                    StellarSdk.xdr.ScVal.scvSymbol(badgeName)
                );

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Badge Purchased!");
                fetchBalance();
                // Logic to display badge would go here
            } catch (e) { console.error(e); alert("Purchase failed (Insufficient BZR?)"); }
        }

        async function checkBadges() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("has_badge", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvSymbol("verified"));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);

                if (StellarSdk.scValToNative(response.result.retval)) {
                    document.getElementById('tier-name').innerHTML += ' <span title="Verified Merchant">‚úÖ</span>';
                }
            } catch (e) { console.log("Error checking badges", e); }
        }

        async function fetchCrowdfund() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_crowdfund_balance");
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const fund = StellarSdk.scValToNative(response.result.retval);

                document.getElementById('fund-display').innerText = `${fund} BZR`;
                document.getElementById('fund-bar').style.width = `${Math.min((fund / 1000) * 100, 100)}%`;
            } catch (e) { console.log("Error fetching fund", e); }
        }

        async function contributeCrowdfund() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("deposit_crowdfund", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvU32(10));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Contributed 10 BZR!"); fetchBalance(); fetchCrowdfund();
            } catch (e) { console.error(e); alert("Contribution failed"); }
        }

        async function vote(propId, inFavor) {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("vote",
                    new StellarSdk.Address(publicKey).toScVal(),
                    StellarSdk.xdr.ScVal.scvU32(propId),
                    StellarSdk.xdr.ScVal.scvBool(inFavor)
                );

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Vote Cast!"); fetchVoteStats(propId);
            } catch (e) { console.error(e); alert("Vote failed (Already voted or no BZR?)"); }
        }

        async function fetchVoteStats(propId) {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_proposal_stats", StellarSdk.xdr.ScVal.scvU32(propId));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const [yes, no] = response.result.retval.value().map(v => StellarSdk.scValToNative(v));
                document.getElementById(`vote-stats-${propId}`).innerText = `Yes: ${yes} BZR | No: ${no} BZR`;
            } catch (e) { console.log("Error fetching votes", e); }
        }

        async function createProposal() {
            try {
                if (!confirm("Create a new proposal? This costs 100 BZR.")) return;

                console.log("Creating Proposal...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("create_proposal", new StellarSdk.Address(publicKey).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Proposal Created!"); fetchBalance();
            } catch (e) { console.error(e); alert("Failed to create proposal (Insufficient BZR?)"); }
        }

        async function raiseDispute() {
            const target = prompt("Enter the Public Key (G...) to dispute:");
            if (!target) return;

            try {
                console.log("Raising Dispute...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("raise_dispute",
                    new StellarSdk.Address(publicKey).toScVal(),
                    new StellarSdk.Address(target).toScVal()
                );

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Dispute Raised! Target flagged.");
            } catch (e) { console.error(e); alert("Dispute failed."); }
        }

        async function resolveDispute() {
            const target = prompt("Enter the Public Key (G...) to resolve:");
            if (!target) return;

            try {
                console.log("Resolving Dispute...");
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("resolve_dispute", new StellarSdk.Address(target).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Dispute Resolved!");
            } catch (e) { console.error(e); alert("Resolution failed. Are you Admin?"); }
        }

        async function setNickname() {
            const nick = document.getElementById('nickname-input').value;
            if (!nick) return alert("Please enter a nickname");
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("set_nickname", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvSymbol(nick));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Nickname Saved!"); fetchNickname();
            } catch (e) { console.error(e); alert("Failed to save nickname."); }
        }

        async function fetchNickname() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_nickname", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                document.getElementById('current-nickname').innerText = StellarSdk.scValToNative(response.result.retval);
            } catch (e) { console.log("Error fetching nickname", e); }
        }

        async function searchNickname() {
            const nick = document.getElementById('search-input').value;
            if (!nick) return;
            try {
                console.log(`Searching for ${nick}...`);
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("get_address_by_nickname", StellarSdk.xdr.ScVal.scvSymbol(nick));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);

                if (response.result.retval.switch().name === "scvVoid") {
                    alert("User not found.");
                } else {
                    const address = StellarSdk.Address.fromScVal(response.result.retval).toString();
                    prompt("User Found! Copy address:", address);
                }
            } catch (e) { console.error(e); alert("Search failed."); }
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
            document.body.classList.remove('hacker-mode');
            const theme = document.body.classList.contains('light-mode') ? 'light' : 'dark';
            localStorage.setItem('bazaar_theme', theme);
        }

        function toggleHackerMode() {
            document.body.classList.toggle('hacker-mode');
            if (document.body.classList.contains('hacker-mode')) {
                document.body.classList.remove('light-mode');
                localStorage.setItem('bazaar_theme', 'hacker');
            } else {
                localStorage.setItem('bazaar_theme', 'dark');
            }
        }

        async function showQRCode() {
            if (!userPublicKey) return alert("Please connect wallet first.");
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${userPublicKey}`;

            const overlay = document.getElementById('custom-modal-overlay');
            document.getElementById('modal-title').innerText = "YOUR IDENTITY";
            document.getElementById('modal-message').innerHTML = `
                <div style="background:white; padding:10px; display:inline-block; border-radius:10px;">
                    <img src="${url}" alt="QR Code" />
                </div>
                <p style="font-size:0.8rem; word-break:break-all; margin-top:10px;">${userPublicKey}</p>
            `;
            document.getElementById('modal-actions').innerHTML = '<button class="modal-btn btn-confirm" onclick="closeModal()">CLOSE</button>';
            overlay.style.display = 'flex';
        }

        let soundEnabled = false;
        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('sound-btn').innerText = soundEnabled ? "üîä" : "üîá";
        }

        function playClickSound() {
            if (!soundEnabled) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.type = 'square';
            osc.frequency.value = 800;
            gain.gain.value = 0.05;
            osc.start();
            setTimeout(() => osc.stop(), 50);
        }

        document.addEventListener('click', (e) => { if (e.target.closest('button')) playClickSound(); });

        // --- üìä CHART & NOTIFICATIONS ---
        let activityChart;
        function initChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Start', 'Wk 1', 'Wk 2', 'Wk 3', 'Today'],
                    datasets: [{
                        label: 'Trust Score',
                        data: [10, 12, 14, 14, merchantState.trustScore],
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#888' } },
                        x: { grid: { display: false }, ticks: { color: '#888' } }
                    }
                }
            });
        }

        function updateChart() {
            if (activityChart) {
                activityChart.data.labels.push('Now');
                activityChart.data.datasets[0].data.push(merchantState.trustScore);
                if (activityChart.data.labels.length > 6) {
                    activityChart.data.labels.shift();
                    activityChart.data.datasets[0].data.shift();
                }
                activityChart.update();
            }
        }

        function toggleNotifications() {
            document.getElementById("notif-dropdown").classList.toggle("show");
            document.getElementById("notif-badge").style.display = "none";
        }

        function addNotification(msg) {
            const drop = document.getElementById("notif-dropdown");
            const badge = document.getElementById("notif-badge");
            if (drop.children.length === 1 && drop.children[0].innerText.includes("No new")) drop.innerHTML = "";
            const item = document.createElement("div"); item.innerHTML = msg; drop.prepend(item);
            if (!drop.classList.contains("show")) { badge.style.display = "block"; badge.innerText = parseInt(badge.innerText || 0) + 1; }
        }

        async function forceUnbond() {
            const targetAddress = prompt("Enter the Public Key (G...) to force unbond:");
            if (!targetAddress) return;

            try {
                if (typeof window.freighterApi === 'undefined') return alert("Wallet not found");
                console.log(`Initiating Force Unbond for ${targetAddress}...`);

                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);

                const op = contract.call("force_unbond", new StellarSdk.Address(targetAddress).toScVal());

                const tx = new StellarSdk.TransactionBuilder(source, {
                    fee: StellarSdk.BASE_FEE,
                    networkPassphrase: StellarSdk.Networks.TESTNET,
                }).addOperation(op).setTimeout(30).build();

                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));

                alert("Force Unbond Successful!");
            } catch (e) {
                console.error("Force Unbond Failed:", e);
                alert("Force Unbond failed. Are you Admin?");
            }
        }

        function switchView(viewName) {
            document.getElementById('dashboard-view').style.display = viewName === 'dashboard' ? 'block' : 'none';
            document.getElementById('map-view').style.display = viewName === 'map' ? 'block' : 'none';
            document.getElementById('history-view').style.display = viewName === 'history' ? 'block' : 'none';
            document.getElementById('shop-view').style.display = viewName === 'shop' ? 'block' : 'none';
            document.getElementById('voting-view').style.display = viewName === 'voting' ? 'block' : 'none';
            document.getElementById('profile-view').style.display = viewName === 'profile' ? 'block' : 'none';
            document.getElementById('graph-view').style.display = viewName === 'graph' ? 'block' : 'none';
            document.getElementById('chat-view').style.display = viewName === 'chat' ? 'block' : 'none';
            document.getElementById('escrow-view').style.display = viewName === 'escrow' ? 'block' : 'none';
            document.getElementById('multisig-view').style.display = viewName === 'multisig' ? 'block' : 'none';
            document.getElementById('premium-view').style.display = viewName === 'premium' ? 'block' : 'none';
            document.getElementById('lottery-view').style.display = viewName === 'lottery' ? 'block' : 'none';
            if(viewName === 'graph') initGraph();
        }

        // --- üì° EVENT LISTENER ---
        async function pollEvents() {
            try {
                // Fetch latest events from the contract
                let response = await server.getEvents({
                    filters: [{
                        type: "contract",
                        contractIds: [CONTRACT_ID],
                    }],
                    startLedger: "latest",
                    limit: 10
                });

                const logDiv = document.getElementById('event-log');
                const historyDiv = document.getElementById('history-list');
                if (response.events.length > 0) {
                    logDiv.innerHTML = ""; // Clear waiting message
                    response.events.forEach(event => {
                        const topic = event.topic.map(t => StellarSdk.scValToNative(t));
                        const data = StellarSdk.scValToNative(event.value);

                        // Format: [TYPE] WHO -> TARGET/VALUE
                        const entry = document.createElement('div');
                        entry.style.borderBottom = "1px solid #333";
                        entry.style.padding = "5px 0";

                        let message = "";
                        if (topic[0] === "vouch") {
                            message = `<span style="color:var(--green)">VOUCH</span>: ${topic[1].substring(0, 4)}.. vouched for ${data.substring(0, 4)}..`;
                            // Notify if it's me
                            if (userPublicKey && data === userPublicKey) {
                                addNotification(`ü§ù <b>${topic[1].substring(0, 4)}...</b> vouched for you!`);
                                merchantState.trustScore += 1; updateUI(); updateChart();
                                updateGraphData(topic[1], data);
                            }
                        } else if (topic[0] === "decay") {
                            message = `<span style="color:var(--red)">DECAY</span>: ${topic[1].substring(0, 4)}.. dropped to ${data}`;
                        } else if (topic[0] === "mint") {
                            message = `<span style="color:var(--pi-purple)">MINT</span>: ${topic[1].substring(0, 4)}.. earned ${data} BZR`;
                            if (userPublicKey && topic[1] === userPublicKey) fetchBalance(); // Refresh balance if it's me
                        } else if (topic[0] === "transfer") {
                            message = `<span style="color:var(--gold)">SEND</span>: ${topic[1].substring(0, 4)}.. sent ${data} BZR to ${topic[2].substring(0, 4)}..`;
                        } else if (topic[0] === "buy") {
                            message = `<span style="color:var(--gold)">SHOP</span>: ${topic[1].substring(0, 4)}.. bought ${topic[2]}`;
                        } else if (topic[0] === "fund") {
                            message = `<span style="color:var(--gold)">FUND</span>: ${topic[1].substring(0, 4)}.. contributed ${data} BZR`;
                        } else if (topic[0] === "referral") {
                            message = `<span style="color:var(--pi-purple)">REF</span>: ${topic[1].substring(0, 4)}.. referred ${data} BZR`;
                        } else if (topic[0] === "vote") {
                            message = `<span style="color:var(--gold)">VOTE</span>: ${topic[1].substring(0, 4)}.. voted on Prop #${topic[2]}`;
                            // Also visualize votes as links
                            updateGraphData(topic[1], "Prop #"+topic[2]);
                        } else if (topic[0] === "lotto_buy") {
                            message = `<span style="color:var(--gold)">LOTTO</span>: ${topic[1].substring(0, 4)}.. bought a ticket (Total: ${data})`;
                        } else if (topic[0] === "lotto_win") {
                            message = `<span style="color:var(--gold)">WINNER</span>: ${topic[1].substring(0, 4)}.. won ${data} BZR!`;
                        } else if (topic[0] === "proposal") {
                            message = `<span style="color:var(--gold)">PROP</span>: ${topic[1].substring(0, 4)}.. created Prop #${data}`;
                        } else if (topic[0] === "dispute") {
                            message = `<span style="color:var(--red)">DISPUTE</span>: ${topic[1].substring(0, 4)}.. flagged ${data.substring(0, 4)}..`;
                        } else if (topic[0] === "resolve") {
                            message = `<span style="color:var(--green)">RESOLVED</span>: Dispute cleared for ${topic[1].substring(0, 4)}..`;
                        } else {
                            message = `<span style="color:var(--gold)">${topic[0]}</span>: ${JSON.stringify(data)}`;
                        }

                        // Add to history array
                        transactionHistory.push({
                            type: topic[0],
                            source: topic[1] || "System",
                            target: data,
                            time: new Date().toISOString()
                        });

                        entry.innerHTML = message;
                        logDiv.prepend(entry);
                        historyDiv.prepend(entry.cloneNode(true)); // Add to history tab too
                    });
                }
            } catch (e) {
                // Silent fail if contract ID is invalid or network error
            }
        }

        // --- ‚õΩ GAS STATION ---
        async function useGasStation() {
            if (!userPublicKey) return alert("Please connect wallet first.");
            try {
                const btn = event.target;
                btn.disabled = true; btn.innerText = "‚è≥ PUMPING...";
                
                const response = await fetch(`https://friendbot.stellar.org/?addr=${userPublicKey}`);
                const data = await response.json();
                
                if (response.ok) {
                    alert("‚õΩ Gas Tank Filled! 10,000 XLM received.");
                } else {
                    alert("Gas Station Error: " + JSON.stringify(data));
                }
                btn.disabled = false; btn.innerText = "‚õΩ REFUEL";
            } catch (e) {
                console.error(e);
                alert("Gas Station unavailable.");
            }
        }

        // --- üï∏Ô∏è D3 GRAPH ---
        let graphNodes = [];
        let graphLinks = [];
        let simulation;

        function initGraph() {
            const container = document.getElementById('d3-container');
            if(!container || container.innerHTML !== "") return; // Don't re-init if already there
            
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#d3-container").append("svg")
                .attr("width", "100%")
                .attr("height", "100%")
                .attr("viewBox", [0, 0, width, height]);

            // Add self if empty
            if(graphNodes.length === 0 && userPublicKey) {
                graphNodes.push({id: userPublicKey, group: 1});
            }

            simulation = d3.forceSimulation(graphNodes)
                .force("link", d3.forceLink(graphLinks).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-400))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const link = svg.append("g").attr("stroke", "#999").attr("stroke-opacity", 0.6).selectAll("line").data(graphLinks).join("line");
            const node = svg.append("g").attr("stroke", "#fff").attr("stroke-width", 1.5).selectAll("circle").data(graphNodes).join("circle").attr("r", 8).attr("fill", d => d.id === userPublicKey ? "var(--gold)" : "var(--pi-purple)").call(drag(simulation));
            node.append("title").text(d => d.id);

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
                node.attr("cx", d => d.x).attr("cy", d => d.y);
            });
        }

        function updateGraphData(source, target) {
            let sNode = graphNodes.find(n => n.id === source);
            let tNode = graphNodes.find(n => n.id === target);
            if(!sNode) graphNodes.push({id: source, group: 2});
            if(!tNode) graphNodes.push({id: target, group: 2});
            
            if(!graphLinks.find(l => l.source.id === source && l.target.id === target)) {
                graphLinks.push({source: source, target: target});
                // Re-render if visible
                if(document.getElementById('graph-view').style.display === 'block') {
                    document.getElementById('d3-container').innerHTML = ""; // Simple clear and redraw
                    initGraph();
                }
            }
        }
        
        function drag(simulation) {
            function dragstarted(event) { if (!event.active) simulation.alphaTarget(0.3).restart(); event.subject.fx = event.subject.x; event.subject.fy = event.subject.y; }
            function dragged(event) { event.subject.fx = event.x; event.subject.fy = event.y; }
            function dragended(event) { if (!event.active) simulation.alphaTarget(0); event.subject.fx = null; event.subject.fy = null; }
            return d3.drag().on("start", dragstarted).on("drag", dragged).on("end", dragended);
        }

        // --- üí¨ CHAT & ESCROW ---
        async function sendMessage() {
            const to = document.getElementById('chat-target').value;
            const text = document.getElementById('chat-content').value;
            if(!to || !text) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                // Simulated Encryption (Base64)
                const encrypted = btoa(text); 
                const op = contract.call("send_message", new StellarSdk.Address(publicKey).toScVal(), new StellarSdk.Address(to).toScVal(), StellarSdk.xdr.ScVal.scvString(`[ENC]${encrypted}`));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Message Sent!"); document.getElementById('chat-content').value = "";
            } catch(e) { console.error(e); alert("Send failed"); }
        }

        async function fetchMessages() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_messages", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const msgs = response.result.retval.vec().map(m => {
                    const obj = m.value(); // Map of fields
                    // Note: Decoding struct from ScVal manually in JS is verbose, simplifying for demo:
                    // In a real app, use the generated bindings or careful parsing.
                    // Assuming we just want to show "New Message" for now or parse if simple.
                    return "üì© Encrypted Message Received"; 
                });
                const list = document.getElementById('message-list');
                list.innerHTML = msgs.map(m => `<div>${m}</div>`).join('');
                if(msgs.length === 0) list.innerHTML = "<div>No messages.</div>";
            } catch(e) { console.log("Error fetching messages", e); }
        }

        async function createEscrow() {
            const seller = document.getElementById('escrow-seller').value;
            const amount = document.getElementById('escrow-amount').value;
            if(!seller || !amount) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("create_escrow", new StellarSdk.Address(publicKey).toScVal(), new StellarSdk.Address(seller).toScVal(), StellarSdk.xdr.ScVal.scvU32(parseInt(amount)));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Escrow Created!"); fetchBalance();
            } catch(e) { console.error(e); alert("Escrow creation failed"); }
        }

        async function approveEscrow() {
            const id = document.getElementById('approve-id').value;
            if(!id) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("approve_escrow", StellarSdk.xdr.ScVal.scvU32(parseInt(id)), new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Escrow Approved!");
            } catch(e) { console.error(e); alert("Approval failed"); }
        }

        // --- üíé PREMIUM ---
        async function subscribe() {
            try {
                if(!confirm("Subscribe for 50 BZR?")) return;
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("subscribe", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Subscribed!"); checkSubscription(); fetchBalance();
            } catch(e) { console.error(e); alert("Subscription failed"); }
        }

        async function checkSubscription() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("is_subscribed", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const isSub = StellarSdk.scValToNative(response.result.retval);
                const el = document.getElementById('sub-status');
                if(isSub) { el.innerText = "ACTIVE ‚úÖ"; el.style.color = "var(--green)"; }
                else { el.innerText = "INACTIVE"; el.style.color = "var(--red)"; }
            } catch(e) { console.log("Error checking sub", e); }
        }

        // --- üîê MULTI-SIG ---
        async function createWallet() {
            const ownersStr = prompt("Enter owner addresses separated by comma (include yourself):");
            const threshold = prompt("Enter threshold (e.g. 2):");
            if(!ownersStr || !threshold) return;
            try {
                const owners = ownersStr.split(',').map(a => new StellarSdk.Address(a.trim()).toScVal());
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("create_wallet", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvVec(owners), StellarSdk.xdr.ScVal.scvU32(parseInt(threshold)));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Wallet Created! Check events for ID.");
            } catch(e) { console.error(e); alert("Create failed"); }
        }

        async function depositWallet() {
            const id = document.getElementById('ms-wallet-id').value;
            const amt = document.getElementById('ms-amount').value;
            if(!id || !amt) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("deposit_wallet", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvU32(parseInt(id)), StellarSdk.xdr.ScVal.scvU32(parseInt(amt)));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Deposited!"); fetchBalance();
            } catch(e) { console.error(e); alert("Deposit failed"); }
        }

        async function proposeTx() {
            const wid = document.getElementById('ms-wallet-id').value;
            const to = document.getElementById('ms-to').value;
            const amt = document.getElementById('ms-amount').value;
            if(!wid || !to || !amt) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("propose_tx", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvU32(parseInt(wid)), new StellarSdk.Address(to).toScVal(), StellarSdk.xdr.ScVal.scvU32(parseInt(amt)));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Tx Proposed! Check events for Tx ID.");
            } catch(e) { console.error(e); alert("Proposal failed"); }
        }

        async function approveTx() {
            const txid = document.getElementById('ms-tx-id').value;
            if(!txid) return;
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("approve_tx", new StellarSdk.Address(publicKey).toScVal(), StellarSdk.xdr.ScVal.scvU32(parseInt(txid)));
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Approved!");
            } catch(e) { console.error(e); alert("Approval failed"); }
        }

        // --- üé∞ LOTTERY ---
        async function buyTicket() {
            try {
                if(!confirm("Buy ticket for 10 BZR?")) return;
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("buy_ticket", new StellarSdk.Address(publicKey).toScVal());
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Ticket Purchased!"); fetchLotteryInfo(); fetchBalance();
            } catch(e) { console.error(e); alert("Purchase failed"); }
        }

        async function runLottery() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("run_lottery");
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const signedXdr = await window.freighterApi.signTransaction(tx.toXDR(), { network: "TESTNET" });
                await server.submitTransaction(new StellarSdk.Transaction(signedXdr, StellarSdk.Networks.TESTNET));
                alert("Lottery Run! Check events for winner."); fetchLotteryInfo();
            } catch(e) { console.error(e); alert("Run failed (Admin only?)"); }
        }

        async function fetchLotteryInfo() {
            try {
                const publicKey = await window.freighterApi.getPublicKey();
                const source = await server.loadAccount(publicKey);
                const contract = new StellarSdk.Contract(CONTRACT_ID);
                const op = contract.call("get_lottery_info");
                const tx = new StellarSdk.TransactionBuilder(source, { fee: StellarSdk.BASE_FEE, networkPassphrase: StellarSdk.Networks.TESTNET }).addOperation(op).setTimeout(30).build();
                const response = await server.simulateTransaction(tx);
                const count = StellarSdk.scValToNative(response.result.retval);
                document.getElementById('lotto-pot').innerText = `Pot: ${count * 10} BZR`;
            } catch(e) { console.log("Error fetching lotto", e); }
        }

        function triggerEmergency() {
            // REPLACED standard alert() with showModal()
            showModal(
                "üö® MEDICAL PROTOCOL",
                "Emergency Signal Broadcasted. Your Security Circle has been notified to sign vouchers. Account Freeze Initiated.",
                "alert"
            );
        }

        // --- üíæ THEME PERSISTENCE ---
        const savedTheme = localStorage.getItem('bazaar_theme');
        if (savedTheme === 'light') {
            document.body.classList.add('light-mode');
        } else if (savedTheme === 'hacker') {
            document.body.classList.add('hacker-mode');
        }

        // Initialize
        updateUI();

        // Start Event Polling (Every 5 seconds)
        setInterval(pollEvents, 5000);

    </script>
    <footer
        style="margin-top: 40px; text-align: center; padding-bottom: 20px; border-top: 1px solid #333; padding-top: 20px;">
        <div style="display: flex; justify-content: center; gap: 15px; align-items: center;">
            <span style="font-size: 0.7rem; color: var(--text-dim); letter-spacing: 1px; font-weight: bold;">PROJECT
                BAZAAR v2.0.26</span>
            <div
                style="background: var(--pi-purple); color: var(--gold); font-size: 0.6rem; padding: 2px 8px; border-radius: 4px; border: 1px solid var(--gold); font-weight: bold;">
                PiOS COMPATIBLE
            </div>
        </div>
        <p style="font-size: 0.6rem; color: var(--text-dim); margin-top: 10px; font-style: italic;">
            By Pioneers. For Pioneers. In Code We Trust.
        </p>
    </footer>
</body>

</html>